#!/bin/sh

user=$USER
master='localhost'

while [ $# -gt 0 ]
do
	case $1 in
	-u|--user)
		user=$2
		shift
		;;
	-m|--master)
		master=$2
		shift
		;;
	-s|--slaves)
		slaves=$2
		shift
		;;
	*)
		echo "usage: `basename $0 [-m|--master <host name>] [-s|--slaves <slave list>]`"
		exit 1
	esac

	shift
done

cp -v configs/config-hadoop-2.7 .config || exit 1

if [ -n "$slaves" ]; then
	cat >> .config << EOF
config_master=$master
config_slaves=$slaves
EOF
fi

echo "Deploying MDH ($mode mode)"
echo "Cluster nodes:"
i=0
for host in ${hosts[@]}
do
	((i++))
	echo "[$i] $host"
done

for host in ${hosts[@]}
do
	ssh-copy-id $host
done

temp=`mktemp -d`
# copy mdh
cp -r $PWD $temp
wd=$temp/`basename $PWD`
# ssh key
pk=$temp/ssh/id_rsa.pub
mkdir `dirname $pk`
ssh-keygen -P '' -f $pk

total=${#hosts[@]}
for ((i=0; i<$total;i++))
do
	host=${hosts[$i]}
	echo "[$((i+1))/$total] $host"
	scp -q -r $temp $user@$host:/tmp/
	ssh $user@$host sudo $wd/deploy-one --id $i --key $pk || exit 1
	echo
done

for app in $apps
do
	ssh $user@$master sudo service $app start || exit 1
	if [ $app = 'hadoop' ]; then
		ssh $user@$master sudo service $app init || exit 1
	fi
done
